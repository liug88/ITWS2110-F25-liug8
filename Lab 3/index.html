<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troy Weather & Pok√©mon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background:
                /* Cute scattered pixel clouds */
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.3) 2%, transparent 2%),
                radial-gradient(circle at 60% 20%, rgba(255, 255, 255, 0.25) 1.5%, transparent 1.5%),
                radial-gradient(circle at 80% 60%, rgba(255, 255, 255, 0.2) 2.5%, transparent 2.5%),
                radial-gradient(circle at 40% 70%, rgba(255, 255, 255, 0.3) 1.8%, transparent 1.8%),
                radial-gradient(circle at 15% 80%, rgba(255, 255, 255, 0.25) 2.2%, transparent 2.2%),
                radial-gradient(circle at 90% 40%, rgba(255, 255, 255, 0.2) 1.5%, transparent 1.5%),
                /* Soft pastel gradient background */
                linear-gradient(135deg, #87CEEB 0%, #98D8E8 25%, #FFB6D9 50%, #D4A5D4 75%, #B8B8FF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            color: #5A4A7A !important;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }
        .weather-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .pokemon-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .pokemon-card:hover {
            transform: translateY(-5px);
        }
        .pokemon-sprite {
            width: 96px;
            height: 96px;
        }
        .weather-icon {
            font-size: 4rem;
        }
        .temp {
            font-size: 3rem;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .metadata {
            font-size: 0.85rem;
            color: #666;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center text-white mb-4">Troy, NY Weather Dashboard</h1>
        
        <div id="loading" class="loading weather-card">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Fetching weather data and catching Pok√©mon...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Weather Section -->
            <div class="weather-card">
                <h2>Current Weather</h2>
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="weather-icon" id="weatherIcon"></div>
                        <div class="temp" id="temperature"></div>
                        <p class="lead" id="description"></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Feels Like:</strong> <span id="feelsLike"></span></p>
                        <p><strong>Humidity:</strong> <span id="humidity"></span></p>
                        <p><strong>Wind Speed:</strong> <span id="windSpeed"></span></p>
                        <p><strong>Pressure:</strong> <span id="pressure"></span></p>
                        <p><strong>Visibility:</strong> <span id="visibility"></span></p>
                    </div>
                </div>
                <div class="metadata" id="metadata"></div>
            </div>

            <!-- Pok√©mon Section -->
            <div class="weather-card">
                <h2 id="pokemonTitle">Weather-Themed Pok√©mon</h2>
                <p id="pokemonSubtitle"></p>
                <div class="pokemon-grid" id="pokemonGrid"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        const WEATHER_API_KEY = 'c07371c77c27c37589415ab178c72cbe'; // Replace with your API key
        const TROY_COORDS = { lat: 42.7284, lon: -73.6918 }; // Fallback coordinates

        let userLocation = null; // Will store user's location if available

        // Weather to Pok√©mon type mapping
        const weatherToPokemonType = {
            'Clear': 'fire',
            'Clouds': 'flying',
            'Rain': 'water',
            'Drizzle': 'water',
            'Thunderstorm': 'electric',
            'Snow': 'ice',
            'Mist': 'ghost',
            'Fog': 'ghost',
            'Haze': 'poison'
        };

        // HTML5 Geolocation API - Get user's location
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.log('Geolocation not supported, using Troy, NY');
                    resolve(TROY_COORDS);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        console.log('User location obtained:', coords);
                        resolve(coords);
                    },
                    (error) => {
                        console.log('Geolocation error, using Troy, NY as fallback:', error.message);
                        resolve(TROY_COORDS); // Fallback to Troy, NY
                    }
                );
            });
        }

        async function fetchWeather() {
            // Use user's location if available, otherwise use Troy, NY
            const coords = userLocation || TROY_COORDS;
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${coords.lat}&lon=${coords.lon}&appid=${WEATHER_API_KEY}&units=imperial`;
            
            // Option 1: Modern Fetch API (what you currently have)
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Weather API error: ${response.status} ${response.statusText}`);
            }
            
            // Log HTTP headers metadata
            console.log('Weather API Response Headers:');
            for (let [key, value] of response.headers.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            const data = await response.json();
            return { data, headers: response.headers };
        }
            
        async function fetchPokemonByType(type) {
            const response = await fetch(`https://pokeapi.co/api/v2/type/${type}`);
            
            if (!response.ok) {
                throw new Error(`Pok√©API error: ${response.status} ${response.statusText}`);
            }
            
            console.log('Pok√©API Response Headers:');
            for (let [key, value] of response.headers.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            const data = await response.json();
            // Get 6 random Pok√©mon of this type
            const pokemon = data.pokemon;
            const shuffled = pokemon.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 6);
        }
            
        async function fetchPokemonDetails(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Pokemon details error: ${response.status}`);
            }
            const data = await response.json();
            return data;
        }

        function displayWeather(weatherData, headers) {
            const { main, weather, wind, visibility, dt, sys } = weatherData;

            $('#temperature').text(`${Math.round(main.temp)}¬∞F`);
            $('#description').text(weather[0].description);
            $('#feelsLike').text(`${Math.round(main.feels_like)}¬∞F`);
            $('#humidity').text(`${main.humidity}%`);
            $('#windSpeed').text(`${wind?.speed || 0} mph`);
            $('#pressure').text(`${main.pressure} hPa`);
            $('#visibility').text(`${((visibility || 0) / 1609.34).toFixed(1)} miles`);

            // Weather icon
            const iconMap = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Mist': 'üå´Ô∏è',
                'Fog': 'üå´Ô∏è'
            };
            $('#weatherIcon').text(iconMap[weather[0].main] || 'üåà');

            // Display metadata from headers AND JSON response
            let metadataHTML = '<strong>API Metadata:</strong> ';

            // Try to get headers (may be blocked by CORS)
            const contentType = headers.get('content-type');
            const cacheControl = headers.get('cache-control');

            // Get metadata from JSON response (always available)
            const dataTimestamp = new Date(dt * 1000).toLocaleString();
            const sunrise = new Date(sys.sunrise * 1000).toLocaleTimeString();
            const sunset = new Date(sys.sunset * 1000).toLocaleTimeString();

            if (contentType) {
                metadataHTML += `Content-Type: ${contentType} | `;
            }
            metadataHTML += `Data Timestamp: ${dataTimestamp} | `;
            metadataHTML += `Sunrise: ${sunrise} | Sunset: ${sunset}`;

            if (cacheControl) {
                metadataHTML += ` | Cache: ${cacheControl}`;
            }

            $('#metadata').html(metadataHTML);
        }
        
        async function displayPokemon(weatherCondition) {
            const pokemonType = weatherToPokemonType[weatherCondition] || 'normal';

            // Convert weather condition to friendly format
            const weatherDescriptions = {
                'Clear': 'Sunny',
                'Clouds': 'Cloudy',
                'Rain': 'Rainy',
                'Drizzle': 'Drizzly',
                'Thunderstorm': 'Stormy',
                'Snow': 'Snowy',
                'Mist': 'Misty',
                'Fog': 'Foggy',
                'Haze': 'Hazy'
            };

            const friendlyWeather = weatherDescriptions[weatherCondition] || weatherCondition;

            $('#pokemonTitle').text(`${friendlyWeather} Weather Pok√©mon`);
            $('#pokemonSubtitle').text(`Here are some ${pokemonType}-type Pok√©mon that match today's weather!`);
            
            try {
                const pokemonList = await fetchPokemonByType(pokemonType);
                const grid = $('#pokemonGrid');
                grid.empty();
                
                for (const item of pokemonList) {
                    const details = await fetchPokemonDetails(item.pokemon.url);
                    
                    const spriteUrl = details.sprites.front_default || 'https://via.placeholder.com/96';
                    const pokemonName = details.name || 'Unknown';
                    
                    const card = $(`
                        <div class="pokemon-card">
                            <img src="${spriteUrl}" alt="${pokemonName}" class="pokemon-sprite">
                            <h5 class="mt-2">${pokemonName.charAt(0).toUpperCase() + pokemonName.slice(1)}</h5>
                            <small class="text-muted">#${details.id || '???'}</small>
                        </div>
                    `);
                    
                    grid.append(card);
                }
            } catch (error) {
                console.error('Error fetching Pokemon:', error);
                $('#pokemonGrid').html('<p class="text-danger">Error loading Pok√©mon data</p>');
            }
        }

        async function init() {
            try {
                // Step 1: Get user's location using HTML5 Geolocation API
                userLocation = await getUserLocation();

                // Step 2: Fetch weather data for that location
                const { data: weatherData, headers } = await fetchWeather();

                // Step 3: Update title to show location name
                const locationName = weatherData.name || 'Your Location';
                $('h1').text(`${locationName} Weather Dashboard`);

                // Step 4: Display weather and Pokemon
                displayWeather(weatherData, headers);
                await displayPokemon(weatherData.weather[0].main);

                $('#loading').hide();
                $('#content').fadeIn();
            } catch (error) {
                console.error('Error:', error);
                $('#loading').html(`
                    <div class="alert alert-danger">
                        <h4>Error Loading Data</h4>
                        <p>Please make sure you've added your OpenWeatherMap API key.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `);
            }
        }

        $(document).ready(init);
    </script>
</body>
</html>